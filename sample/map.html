<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>Cesium</title>
	<link rel="stylesheet" href="./demo.css" />
	<link rel="stylesheet" href="../src/engine/cesium/Widgets/widgets.css" />
	<link rel="stylesheet" href="../externlib/jquery-ui/jquery-ui.css" />
	<script type="text/javascript" src="../externlib/jquery/jquery.js"></script>
	<script type="text/javascript" src="../externlib/jquery-i18next/jquery-i18next.min.js"></script>
	<script type="text/javascript" src="../externlib/polyfill/decodeTextAlternative/encoding-indexes.js"></script>
	<script type="text/javascript" src="../externlib/polyfill/decodeTextAlternative/encoding.js"></script>
</head>

<body>
	<input type="hidden" id="now_latitude" name="now_latitude" value="" />
	<input type="hidden" id="now_longitude" name="now_longitude" value=""  />
<ul class="nav i18n">
	<li id="homeMenu" class="home">
		<img src="/images/ko/homepage/home-icon.png" style="width: 35px; height: 35px; padding-right: 2px;" title="Home" />
	</li>
	<li onclick="doTest();">
		test
	</li>
</ul>
<div id="magoContainer" class="mapWrap"></div>

<script type="text/javascript" src="../src/engine/cesium/Cesium.js"></script>
<script type="text/javascript" src="../build/mago3d/mago3d.js"></script>
<script>
	var message = new Mago3D.Message(i18next);
	
	//f4d path, default data array, 
	var dataInfo = {
		baseUrl : '/f4d',
		dataArrat : []
	}

	function changeLang(lang) 
	{
		if(i18next === undefined)
		{
			return;
		}
		
		var language = lang || i18next.language;
		var namespace = i18next.options.ns[0];

		$.ajax({
			url: "/locales/"+namespace+"/"+language+".json",
			type: "GET",
			dataType: "json",
			success: function(data){
				i18next.addResourceBundle(language, namespace, data, true, true);
				i18next.changeLanguage(language);
			},
			error: function(e){
				alert(e.responseText);
			}
		});
	}
	
	message.init(function (){
		i18next = message.getHandle();
		i18next.on('languageChanged', function (lang) {
			$('.i18n').localize();
		});
		jqueryI18next.init(i18next, $);
		changeLang();
	});

	var MAGO3D_INSTANCE;
	var imagePath = "/images/ko";
	var dataInformationUrl = "/sample/persistence/json/";
	magoStart(null, "magoContainer", imagePath);

    // mago3d 시작, 정책 데이터 파일을 로딩
	function magoStart(viewer, renderDivId, imagePath) {
		$.ajax({
			url: dataInformationUrl + "geopolicy.json",
			type: "GET",
			dataType: "json",
			success: function(serverPolicy){
				var cesiumViewerOption = {};
				cesiumViewerOption.infoBox = false;
				cesiumViewerOption.navigationHelpButton = false;
				cesiumViewerOption.selectionIndicator = false;
				cesiumViewerOption.homeButton = false;
				cesiumViewerOption.fullscreenButton = false;
				cesiumViewerOption.geocoder = false;
				cesiumViewerOption.baseLayerPicker = false;
				cesiumViewerOption.sceneModePicker = false;

				serverPolicy.basicGlobe = 'cesium';
				serverPolicy.cesiumIonToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyNmNjOWZkOC03NjdlLTRiZTktYWQ3NS1hNmQ0YjA1ZjIzYWEiLCJpZCI6Mzk5Miwic2NvcGVzIjpbImFzciIsImdjIl0sImlhdCI6MTU0NDYwNDQ3M30.AwvoVAuMRwjcMMJ9lEG2v4CPUp8gfltJqZARHgxGv_k";
				serverPolicy.terrainType = 'cesium-default'

				serverPolicy.initLatitude = 37.43601055850527;
				serverPolicy.initLongitude = 126.8008658032687;
				serverPolicy.initAltitude = 3000;
				MAGO3D_INSTANCE = new Mago3D.Mago3d(renderDivId, serverPolicy, {loadend : loadend}, cesiumViewerOption);
			},
			error: function(e){
				alert(e.responseText);
			}
		});
	}
	function loadend(e) {
		console.info('Complete construct mago3d instance. Enjoy!');
		
		var magoInstance = e;
		console.info(magoInstance)
		magoInstance.getViewer().scene.globe.depthTestAgainstTerrain = true;
		magoInstance.setBaseUrl(dataInfo.baseUrl);


		var osm = new Cesium.OpenStreetMapImageryProvider({
			url : 'https://{s}.tile.openstreetmap.org/'
		});

		var positron = new Cesium.UrlTemplateImageryProvider({
			url : 'http://xdworld.vworld.kr:8080/2d/Base/201802/{z}/{x}/{y}.png'
		});

		//magoInstance.getViewer().imageryLayers.addImageryProvider(osm,1);
		
		var magoManager = magoInstance.getMagoManager();
		var viewer = magoInstance.getViewer();
		var provider = new Cesium.WebMapServiceImageryProvider({
			url : 'http://localhost:8080/geoserver/mago3d/gwc/service/wms',
			layers : 'mago3d:susim_5m',
			tilingScheme : new Cesium.WebMercatorTilingScheme(),
			parameters: {
				tiled: true,
				transparent : true,
				srs : 'EPSG:3857',
            	format: "image/png"
			}
		});
		var aa = new Cesium.ImageryLayer(provider, {
			alpha : 0.9
		});
//viewer.imageryLayers.add(aa);
		var layer = new Mago3D.MagoLayer({
			dataGroupId : 1,
			dataGroupKey : '3ds',
			dataGroupName : '삼디에스',
			dataGroupPath : '/3ds'
		});
		
		magoManager.addLayer(layer);

		magoManager.on(Mago3D.MagoManager.EVENT_TYPE.CLICK, function(e){
			console.info(e);
		});

		magoManager.on(Mago3D.MagoManager.EVENT_TYPE.SELECTEDF4D, function(e){
			console.info(e);
		});

		magoManager.on(Mago3D.MagoManager.EVENT_TYPE.DESELECTEDF4D, function(e){
			console.info(e);
		});
	}
	
	function doTest(){
		var f4dController = MAGO3D_INSTANCE.getF4dController();
		var magoManager = MAGO3D_INSTANCE.getMagoManager();
		$.ajax({
			url: dataInformationUrl + "sh_struc.json",
			type: "GET",
			dataType: "json",
			success: function(f4dObject){
				f4dController.addF4dGroup(f4dObject);

				var box = new Mago3D.Box(30,30, 80);
				if(!box.attributes) box.attributes = {};
				box.attributes.isMovable = true;
				box.setGeographicPosition(new Mago3D.GeographicCoord(126.8014658032687, 37.43653055850527, 14.177629));
				box.setOneColor(0.2, 0.7, 0.8, 0.4);
				box.attributes.selectedColor4 = new Mago3D.Color(1.0, 1.0, 0.0, 1.0); // selectedColor fully transparent.

				MAGO3D_INSTANCE.getMagoManager().modeler.addObject(box, 5);

				var arrow = new Mago3D.Arrow(30,15, 80);
				if(!arrow.attributes) arrow.attributes = {};
				arrow.attributes.isMovable = true;
				arrow.setGeographicPosition(new Mago3D.GeographicCoord(126.8014658032687, 37.43683055850527, 14.177629));

				arrow.setOneColor(0.2, 0.7, 0.8, 0.4);
				arrow.attributes.selectedColor4 = new Mago3D.Color(1.0, 1.0, 0.0, 1.0); // selectedColor fully transparent.

				MAGO3D_INSTANCE.getMagoManager().modeler.addObject(arrow, 5);

				var cyl = new Mago3D.Cylinder(30,80);
				if(!cyl.attributes) cyl.attributes = {};
				cyl.attributes.isMovable = true;
				cyl.setGeographicPosition(new Mago3D.GeographicCoord(126.8014658032687, 37.43601055850527, 14.177629));

				cyl.setOneColor(0.2, 0.7, 0.8, 0.4);
				cyl.attributes.selectedColor4 = new Mago3D.Color(1.0, 1.0, 0.0, 1.0); // selectedColor fully transparent.

				MAGO3D_INSTANCE.getMagoManager().modeler.addObject(cyl, 5);
				
				MAGO3D_INSTANCE.getMagoManager().addStaticModel({
					projectId : 'tree',
					projectFolderName : 'lh-data',
					buildingFolderName : 'F4D_tree'
				});
				MAGO3D_INSTANCE.getMagoManager().addStaticModel({
					projectId : 'sj173006',
					projectFolderName : 'lh-data',
					buildingFolderName : 'F4D_sj173006'
				});
				MAGO3D_INSTANCE.getMagoManager().addStaticModel({
					projectId : 'SJGSLJ1002',
					projectFolderName : 'lh-data',
					buildingFolderName : 'F4D_SJGSLJ1002'
				});

				var treeStart = new Mago3D.GeographicCoord(126.80127456160453,37.43790781930617,5);
				var treeEnd = new Mago3D.GeographicCoord(126.79868978138177,37.38050571056221,5);
				var treePositions = Mago3D.GeographicCoordSegment.getArcInterpolatedGeoCoords(treeStart, treeEnd, 8);

				var slStart = new Mago3D.GeographicCoord(126.80449676241084,37.43770221908449,5);
				var slEnd = new Mago3D.GeographicCoord(126.79868978138177,37.38050571056221,5);
				var slPositions = Mago3D.GeographicCoordSegment.getArcInterpolatedGeoCoords(slStart, slEnd, 2);

				var spStart = new Mago3D.GeographicCoord(126.80239144274829,37.4348109445351,5);
				var spEnd = new Mago3D.GeographicCoord(126.8030056869661,37.37929383761813,5);
				var spPositions = Mago3D.GeographicCoordSegment.getArcInterpolatedGeoCoords(spStart, spEnd, 2);
				
				for(var i in treePositions)
				{
					var position = treePositions[i];
					MAGO3D_INSTANCE.getMagoManager().instantiateStaticModel({
						projectId : 'tree',
						instanceId : 'tree'+i,
						longitude : position.longitude,
						latitude : position.latitude,
						height : 0
					});
				}
				for(var i in slPositions)
				{
					var position = slPositions[i];
					MAGO3D_INSTANCE.getMagoManager().instantiateStaticModel({
						projectId : 'sj173006',
						instanceId : 'sj173006'+i,
						longitude : position.longitude,
						latitude : position.latitude,
						height : position.altitude
					});
				}
				for(var i in spPositions)
				{
					var position = spPositions[i];
					MAGO3D_INSTANCE.getMagoManager().instantiateStaticModel({
						projectId : 'SJGSLJ1002',
						instanceId : 'SJGSLJ1002'+i,
						longitude : position.longitude,
						latitude : position.latitude,
						height : position.altitude
					});
				}
			},
			error: function(e){
				alert(e.responseText);
			}
		});

		$.ajax({
			url: dataInformationUrl + "sh.json",
			type: "GET",
			dataType: "json",
			success: function(f4dObject){
				f4dController.addF4dGroup(f4dObject);
			},
			error: function(e){
				alert(e.responseText);
			}
		});
	}
</script>
</body>
</html>